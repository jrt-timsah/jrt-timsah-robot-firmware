# JRT Timsah Robot Firmware (CoRE-2 Robot Firmware)

このファームウェアは、CoRE\-2ベースのロボット用に開発されました。ArduinoシールドVer\.2024およびコントローラ基板Ver\.2を使用し、ディスク射出機構を含む基本的なロボット操作を制御します。

---

## 動作環境と仕様

| 項目 | 詳細 | 備考 |
| :--- | :--- | :--- |
| **対象ロボット** | CoRE\-2ベースロボット | |
| **Arduinoシールド** | Ver\.2024 | |
| **コントローラ基板** | Ver\.2 | |
| **制御周期** | 10 msec (100 Hz) | `period`変数で定義 |
| **通信速度** | 115200 bps | PC、コントローラ、オートレフェリ通信 |
| **射出用モータ** | サーボ制御 (`SHOT`) | ディスク射出動作 |
| **射出用ローラ** | PWM制御 (`ROLLER`) | ディスク回転用 |
| **駆動モータ** | PWM制御 (`WHEEL_L`, `WHEEL_R`) | DCモータ |

---

##  ピン・モータ割付け

| 割付け名 | ポート/ピン | 制御対象 | 制御方法 |
| :--- | :--- | :--- | :--- |
| `WHEEL_L` | `MOTOR1` (PWM 9) | 左タイヤ | PWM制御 |
| `WHEEL_R` | `MOTOR2` (PWM 8) | 右タイヤ | PWM制御 |
| `ROLLER` | `MOTOR3` (PWM 7) | 射出回転ローラー | PWM制御 |
| `PITCH` | `SERVO1` (Pin 13) | ピッチ調整サーボ | サーボ制御 |
| `SHOT` | `SERVO2` (Pin 11) | ディスク射出サーボ | サーボ制御 |
| `EMG_Stop` | `SW12` (Pin 33) | 非常停止スイッチ | デジタル入力 |
| `AF_Signal1` | `AF1` (Pin 62) | オートレフェリ停止信号 | デジタル入力 |

---

## コントローラ入力割付け (Ver\.2用)

コントローラからの受信データ (`RxData`) に基づく入力割付けです。

| 定義名 | `RxData`ビット/配列 | 機能 | 範囲/状態 |
| :--- | :--- | :--- | :--- |
| `SW_ENABLE` | `RxData[4]` (bit 0) | **操作許可スイッチ** | 1: 操作許可 / 0: 操作禁止 |
| `SW_SHOT` | `RxData[4]` (bit 1) | ディスク射出ボタン | 1: 押されている / 0: 離されている |
| `SW_ROLLER` | `RxData[4]` (bit 2) | ローラー回転ボタン | 1: 押されている / 0: 離されている |
| `AS_Left` | `RxData[0]` | 左スティック (前後移動) | \-100 〜 100 |
| `AS_Right` | `RxData[1]` | 右スティック (回転移動) | \-100 〜 100 |
| `AS_Vol` | `RxData[2]` | ピッチ調整ボリューム | 0 〜 255 |

---

## 主要な制御機能

### 1. 走行制御 (`Wheel`)

* **左右独立制御:** `WHEEL_L`は`AS_Left`、`WHEEL_R`は`AS_Right`の値で駆動します。
* **デッドゾーン:** スティック値が**\-20〜\+20**の範囲内ではモータが停止します。

### 2. ピッチ調整 (`Pitch`)

* ボリューム (`AS_Vol`) の値に応じて射出角度を調整します。
* 角度範囲: 約 **45\u00b0** (`AS_Vol`=0) から約 **115\u00b0** (`AS_Vol`=255)。

### 3. ディスク射出シーケンス (`Shot`)

射出ボタン (`SW_SHOT`) が押されたときの自動シーケンスです。

1.  **ローラー起動**: `SW_SHOT`が押され、ローラーが停止状態の場合、ローラーを**80% PWM**で回転開始。
2.  **安定待ち**: ローラー起動後、**1000 msec**の待機時間を設けてローラーの回転を安定させます。
3.  **射出動作**: ローラー回転安定後、**500 msec**のディレイを経て、射出サーボを`shotangle` (160\u00b0)に動かしてディスクを射出します。
4.  **リターン**: `SW_SHOT`が離された後、**500 msec**のディレイを経て、射出サーボを`waitangle` (30\u00b0)に戻します。

### 4. ローラーON/OFF切替 (`Roller`)

ローラーボタン (`SW_ROLLER`) を使用してローラーの回転状態をトグル（ON/OFF切り替え）します。

* **チャタリング対策**: スイッチの連打を防止するため、**500 msec**のインターバルを設定しています。
* **動作**: ローラーは**50% PWM**で回転します。

### 5. 操作禁止時の動作

`OperationReady`が0（操作禁止）の場合、以下の動作を行います:

* 全てのモータを停止 (`MotorAllOFF()`)。
* 射出サーボを待機位置に戻す (`waitangle`へ)。
* オートレフェリ信号1がONの場合はブザーが鳴動 (`Buzzer1ON()`)。

---

## タイムアウト処理 (`RxController`)

コントローラからのデータ受信が**300 msec**以上途絶えた場合、**ControllerTimeout**フラグが`true`となり、全ての`RxData`が0にリセットされます。これにより、ロボットは**操作禁止状態**（`OperationReady = 0`）に移行します。